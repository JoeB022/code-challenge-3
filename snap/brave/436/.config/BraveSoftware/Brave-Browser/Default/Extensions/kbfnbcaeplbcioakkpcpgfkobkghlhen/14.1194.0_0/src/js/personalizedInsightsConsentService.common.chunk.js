(self.webpackChunk=self.webpackChunk||[]).push([[2308],{95694:(t,s,e)=>{e.r(s),e.d(s,{PersonalizedInsightsConsentService:()=>C});var i=e(82823),a=e(18615),n=e(60841),o=e(65647),h=e(78488),r=e(55446),p=e(70989),d=e(25770),_=e(47351),u=e(42530),l=e(1393);class S{constructor(t,s,e,i){this._dapiSettings=t,this._pageState=s,this._dapiActions=e,this._csActions=i,this._getState=()=>{const t=this._dapiSettings[S.LlamaWindowsState],s=this._dapiSettings[S.LlamaMacState],e=this._dapiSettings[S.ExtensionDapiState],i=this._getStateFromLocalStorage();return t||s||e?this._getStateFromDapiSettings(i):i},this._getStateFromDapiSettings=t=>{const s=this._dapiSettings[S.LlamaWindowsState]||this._dapiSettings[S.LlamaMacState]?{hasSeenInOtherProduct:!0}:{},e=this._dapiSettings[S.ExtensionDapiState];return{...e?this._deserialize(e,t):{},...s}},this._getStateFromLocalStorage=()=>this._pageState.personalizedInsightsConsentPopup||{},this._updateLocalStorage=t=>{this._csActions.setPersonalizedInsightsConsentPopupState(t)},this._updateDapi=t=>{const s=this._serialize(t);this._dapiActions.setPersonalizedInsightsConsentState(s)},this._setState=t=>{this._state=t},this._serialize=t=>encodeURI(JSON.stringify(t)),this._deserialize=(t,s)=>{try{const s=decodeURI(t);return JSON.parse(s)}catch(t){return s}},this.update=t=>{const s={...this._state,...t};return this._setState(s),this._updateLocalStorage(s),this._updateDapi(s),s},this._state=this._getState()}get state(){return this._state}}S.ExtensionDapiState="personalizedInsightsConsent:onboardingState:extension",S.LlamaWindowsState="personalizedInsightsConsent:onboardingState:llamaWindows",S.LlamaMacState="personalizedInsightsConsent:onboardingState:llamaMac";var c=e(74111),g=e(42046);class C{constructor(t,s,e,m,I,b,w){this._gButtonPopupController=t,this._experimentClient=s,this._dapiSettings=e,this._user=m,this._pageState=I,this._dapiActions=b,this._csActions=w,this._subs=new i.w,this._allEligibilityChecksPassed=d.h.create(!1),this._initPopup=async()=>{C._isResourceInUse=!0,await this._dapiActions.reloadPropsRateLimited(),this._subs.add(this._pageState.pipe(a.P((t=>!!t.isActiveTab)),n.w((t=>this._dapiSettings.pipe(a.P(),o.U((s=>new S(s,t,this._dapiActions,this._csActions))),h.b((t=>this._personalizedInsightsConsentState=t)),r.h((({state:t})=>this._shouldShowBasedOnPopupState(t))),p.M(this._user,this._gButtonPopupController.state),o.U((([t,s,e])=>{const i="none"===e.type;return this._isExistingUser(s)&&i})))))).subscribe((t=>{this._allEligibilityChecksPassed.set(t)}))),this._subs.add(this._allEligibilityChecksPassed.pipe(r.h(u.fQ),h.b((()=>{this._csActions.reloadUserDataSharingRateLimited()})),n.w((()=>this._pageState.pipe(o.U((t=>{const{dataSharingSettings:s}=t;return{shouldShow:!!s&&"personalizedInsights"in s.features,dataSharingConsentCopy:this._getDataSharingConsentCopyType(s)}})),a.P((({shouldShow:t})=>t)))))).subscribe((({dataSharingConsentCopy:t})=>{setTimeout((()=>{this._gButtonPopupController.updateState({type:"personalizedInsightsConsentPopup",dataSharingConsent:t})}),300)})))},this._isExistingUser=t=>{const s=t.registrationDate?Date.parse(this._formatISOTimestampToUTC(t.registrationDate)):void 0;return!!s&&this._hasOneDayPassed(s)},this._shouldShowBasedOnPopupState=t=>{const s=t.hasSeenInOtherProduct,e=t.isDismissed,i=t.isCompleted,a=!!t.lastSeenTimestamp;return!(s||e||i||a)},this._getDataSharingConsentCopyType=t=>{var s;if(t){const e=null===(s=t.features.personalizedInsights)||void 0===s?void 0:s.dataSharing;return t.consentRequired?e?c.Z.Unknown:c.Z.Required:e?c.Z.NotRequired:c.Z.Unknown}return c.Z.Unknown},this._formatISOTimestampToUTC=t=>"Z"===t.slice(-1)?t:`${t}Z`,this._hasOneDayPassed=t=>Date.now()-t>l.v0,this._isGateEnabled=()=>(0,g.c)(this._experimentClient),this.show=()=>{this._personalizedInsightsConsentState.update({lastSeenTimestamp:Date.now()}),C._isResourceInUse=!1},this.openSettings=()=>{self.open(`${(0,_.rv)()}?hubCustomizeFeatures=1`),this._personalizedInsightsConsentState.update({isCompleted:!0})},this.dismiss=()=>{this._personalizedInsightsConsentState.update({isDismissed:!0})},this._isGateEnabled()&&!C._isResourceInUse&&this._initPopup()}dispose(){C._isResourceInUse=!1,this._subs.unsubscribe()}}C._isResourceInUse=!1},74111:(t,s,e)=>{var i,a;e.d(s,{F:()=>a,Z:()=>i}),function(t){t.Required="Required",t.NotRequired="NotRequired",t.Unknown="Unknown"}(i||(i={})),function(t){t.Ok="Ok",t.Close="Close"}(a||(a={}))}}]);