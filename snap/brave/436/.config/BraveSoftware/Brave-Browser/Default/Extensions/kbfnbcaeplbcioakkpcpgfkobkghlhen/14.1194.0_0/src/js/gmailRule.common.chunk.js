(self.webpackChunk=self.webpackChunk||[]).push([[1330],{17445:(e,t,i)=>{i.d(t,{c:()=>s});var n=i(90522);const s=e=>e.isGateEnabled(n.K.KnowledgeHubGmail)},35312:(e,t,i)=>{i.d(t,{q:()=>n});var n,s=i(11633),o=i(21147);!function(e){let t;!function(e){e.codec=s.UQ(s.Z_,(e=>"string"==typeof e),"AnnotationId"),e.create=function(e){return e},e.eq=o.yv}(t=e.Id||(e.Id={})),e.eq=o.MW({id:t.eq,span:o.MW({s:o.lr,e:o.lr})})}(n||(n={}))},1795:(e,t,i)=>{i.d(t,{Lu:()=>o,hX:()=>n,jA:()=>s});var n,s,o,r=i(63843);!function(e){e.create=function(e){return e}}(n||(n={})),function(e){let t,i;!function(e){e.start="start",e.error="error",e.updateContextInfoFinished="updateContextInfoFinished",e.docFinished="docFinished",e.knowledgeHubItem="knowledgeHubItem"}(t=e.Kind||(e.Kind={})),e.isUpdateContextInfoFinished=function(e){return e.kind===t.updateContextInfoFinished},e.isDocFinished=function(e){return e.kind===t.docFinished},function(e){let i;e.isItem=function(e){return e.kind===t.knowledgeHubItem},function(e){e.create=e=>e,e.toAlertId=e=>e}(i=e.ItemId||(e.ItemId={}))}(i=e.KnowledgeHub||(e.KnowledgeHub={})),e.isKnowledgeHub=i.isItem}(s||(s={})),(0,r.L0)(void 0),function(e){e.LOOKED="LOOKED",e.IGNORE="IGNORE"}(o||(o={}))},80144:(e,t,i)=>{i.d(t,{I:()=>n,n:()=>s});var n,s,o=i(63843),r=i(21147);!function(e){let t,i;!function(e){e.knowledgeHubItem="knowledgeHubItem"}(t=e.Kind||(e.Kind={})),function(e){e.isItem=function(e){return e.kind===t.knowledgeHubItem}}(i=e.KnowledgeHub||(e.KnowledgeHub={}))}(n||(n={})),(0,o.L0)(void 0),function(e){e.eq=r.yv}(s||(s={}))},95416:(e,t,i)=>{i.r(t),i.d(t,{Gmail:()=>fi});var n,s=i(90023),o=i(82823),r=i(30152),a=i(90049),d=i(64965),c=i(65882),l=i(20715),h=i(74857),u=i(65647),g=i(43456),p=i(55446),m=i(34859),_=i(14765);!function(e){e.knowledgeHub="knowledge_hub",e.reader="reader",e.reconnect="reconnect"}(n||(n={}));var f=i(58303),b=i(17445),v=i(62228),x=i(78488),w=i(60841),I=i(63469),C=i(25989),S=i(8748),y=i(25770),k=i(88241),E=i(45661),U=i(45654);class N{constructor(e,t,n,s,a,d=E.OB,c=k.Y.create("gmail.knowledgeHub.pageIntegration")){this._csState=n,this._csActions=s,this._felog=a,this._getEnv=d,this._logger=c,this.type=U.M.generalPurpose,this._subscriptions=new o.w,this._knowledgeHubCSState=y.h.create(v.v3.get(this._csState.page.knowledgeHubSettings)),this._disposed=y.h.create(!1),this.disposed=this._disposed.view(),this._logger.info("Initing knowledgeHubIntegration",{csState:this._csState.page.knowledgeHubSettings}),this._subscriptions.add(this._knowledgeHubCSState.view((e=>e.enabled)).pipe(x.b((e=>this._logger.info("Integration state change. State: "+(e?"on":"off")))),w.w((n=>n?e.pipe(I.cp((({threadContext:e,checkingService:n,annotationsManager:o})=>C.D(Promise.all([i.e(1844),i.e(2444),i.e(6294),i.e(5689),i.e(7709),i.e(8513)]).then(i.bind(i,7380))).pipe(w.w((({createKnowledgeHubThreadIntegration:i})=>new r.y((()=>{const r=i(n,o,e,t,a,s,this._knowledgeHubCSState,this._getEnv);return()=>r()})))))))):S.E))).subscribe()),this._logger.debug("Page integration created")}update(e){this._logger.debug("Received cs state update",e),this._knowledgeHubCSState.set(v.v3.get(e.page.knowledgeHubSettings))}dispose(){this._disposed.set(!0),this._subscriptions.unsubscribe(),this._logger.debug("Page integration disposed")}}var R,O=i(79514),A=i(44025),G=i(80225),z=i(84639),T=i(89594),M=i(46808),L=i(99213),F=i(72925),P=i(55901),j=i(566),q=i(68599),D=i(92014),V=i(557),H=i(88900),K=i(92865),W=i(4433),Y=i(65233),Q=i(52073),$=i(16711),B=i(90522),X=i(79409),Z=i(50293),J=i(24202),ee=i(22236),te=i(58623),ie=i(49144),ne=i(36072),se=i(83780),oe=i(60165),re=i(59833),ae=i(20323),de=i(67325),ce=i(13080),le=i(24184),he=i(72106),ue=i(12518),ge=i(63843),pe=i(87286),me=i(75155),_e=i(39953);!function(e){e.is=function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return function(e){return t.some((function(t){return t===e.kind}))}}}(R||(R={}));class fe{constructor(e,t){this._rpc=e,this._settings=t,this._token=this._rpc.startSession(this._settings),this.setSessionOption=(...e)=>this._token.then((t=>this._rpc.setSessionOption({token:t,args:e}))),this.ping=(...e)=>this._token.then((t=>this._rpc.ping({token:t,args:e}))),this.close=(...e)=>this._token.then((t=>this._rpc.close({token:t,args:e}))),this.sendFeedback=(...e)=>this._token.then((t=>this._rpc.sendFeedback({token:t,args:e}))),this.getStatus=(...e)=>this._token.then((t=>this._rpc.getStatus({token:t,args:e}))),this.getStatusObs=(...e)=>this._token.then((t=>this._rpc.getStatusObs({token:t,args:e}))),this.getEventsObs=(...e)=>this._token.then((t=>this._rpc.getEventsObs({token:t,args:e}))),this.connect=(...e)=>this._token.then((t=>this._rpc.connect({token:t,args:e}))),this.updateContextInfo=(...e)=>this._token.then((t=>this._rpc.updateContextInfo({token:t,args:e})))}dispose(){this._token.then((e=>this._rpc.stopSession(e)))}}var be=i(91059);class ve{constructor(e,t,i,s,o,r,a,d,c=E.OB,l=k.Y.create("StaticCAPIRpcConnection")){this._domainName=e,this._capiUrl=t,this._supportedFeatures=i,this._clientName=s,this._clientSubType=o,this._clientVersion=r,this._useDlp=a,this._startSessionOptions=d,this._getEnv=c,this._log=l,this._id=be._.createWithRandomId("dn"),this._sessionUuid=null,this._initialSessionUuid=null,this._attemptingReconnect=!1,this._reconnectRequestIncludesReconnectInfo=!1,this._subscriptions=[],this._reconnectInfo=f.YP,this._reconnectionStatus=y.h.create(me.Td.ready),this._connectionStatus=y.h.create(me.QK.waitingForConnection),this.getStatusObs=()=>this._rpc.getStatusObs(),this.reconnect=(e=!0)=>(this.close("Need to reconnect"),e?(this._attemptingReconnect=!0,this._reconnectRequestIncludesReconnectInfo=f.pC(this._reconnectInfo),this._log.debug("[RECONNECT] Reconnecting to existing CAPI session")):(this._attemptingReconnect=!1,this._reconnectRequestIncludesReconnectInfo=!1,this._reconnectInfo=f.YP),this._reconnectionStatus.set(me.Td.inProgress),this._initRpcClient(),this._connectionStatus.set(me.QK.startingConnection),this._rpc.connect()),this.close=e=>{this._log.trace("Closing connection.",{reason:e}),this._rpc.close(e).catch((t=>{this._log.warn("Can't close api instance",{reason:e,error:t.message?t.message:JSON.stringify(t)})})),this._rpc.dispose(),this._cleanListeners(),this._connectionStatus.set(me.QK.waitingForReconnection)},this.getEventsObs=()=>this._rpc.getEventsObs(),this.sendFeedback=async e=>this._reconnectionStatus.get()===me.Td.reconnectRequired?(await this.reconnect(),this._rpc.sendFeedback(e)):this._rpc.sendFeedback(e),this.setSessionOption=async e=>this._reconnectionStatus.get()===me.Td.reconnectRequired?(await this.reconnect(),this._rpc.setSessionOption(e)):this._rpc.setSessionOption(e),this.updateContextInfo=async e=>this._reconnectionStatus.get()===me.Td.reconnectRequired?(await this.reconnect(),this._rpc.updateContextInfo(e)):this._rpc.updateContextInfo(e),this._onSessionStart=({sessionUuid:e,isNewSession:t,reconnectedInfo:i})=>{if(this._sessionUuid=e,t){if(this._log.debug(`[RECONNECT] Initing new session (${e})`),this._id=be._.createWithRandomId("dn"),this._connectionStatus.set(me.QK.newSessionStarted),this._attemptingReconnect){const e=(0,me.x)(this._reconnectRequestIncludesReconnectInfo,i);(0,X.Tb)().sendFemetricsRate("reconnectToSessionFailed",{reconnectFailedReason:e}),this._log.debug("[RECONNECT] reconnect failed",e)}this._log.debug(`[RECONNECT] New session (${e})`)}else this._log.debug(`[RECONNECT] Continuing existing session (${e})`),this._connectionStatus.set(me.QK.existingSessionStarted),(0,X.Tb)().sendFemetricsRate("reconnectToSessionSuccess");this._attemptingReconnect=!1,this._initialSessionUuid=this._initialSessionUuid||e,this._reconnectionStatus.set(me.Td.ready)},this._initListeners=()=>{this._subscriptions.push(C.D(this.getEventsObs()).pipe(le.B()).subscribe((e=>{R.is("session_started")(e)?this._onSessionStart(e):R.is("reconnect_info_updated")(e)&&this._onReconnectInfo(e)})))},this._onReconnectInfo=e=>{this._log.debug("Update reconnect info",e.reconnectInfo),this._reconnectInfo=f.ij(e.reconnectInfo)},this._cleanListeners=()=>{this._subscriptions.forEach((e=>e.unsubscribe())),this._subscriptions=[]},this._initRpcClient=()=>{this._rpc=new fe(this._getEnv().staticCapiBgRpc.api,{domain:this._domainName,capiUrl:this._capiUrl,supportedFeatures:this._supportedFeatures.includes(n.reconnect)?this._supportedFeatures:[...this._supportedFeatures,n.reconnect],clientName:this._clientName,clientSubType:this._clientSubType,clientVersion:this._clientVersion,startSessionOptions:{...this._startSessionOptions,...(0,_e.zG)(this._reconnectInfo,f.g_((()=>this._initialSessionUuid?{reconnectInfo:{sessionUuid:this._initialSessionUuid}}:{}),(e=>({reconnectInfo:e}))))},useDlp:this._useDlp}),this._initListeners()},this._listenSWShutdown=()=>{this._getEnv().message.on("bgSW-shutdown",(()=>{this._reconnectionStatus.get()!==me.Td.reconnectRequired&&this._connectionStatus.get()!==me.QK.waitingForConnection&&(this._log.debug("[RECONNECT] Lost connection to service worker. Queuing up reconnection."),this._reconnectionStatus.set(me.Td.reconnectRequired))}))},this._initRpcClient(),this._listenSWShutdown()}get id(){return this._id}get sessionUuid(){return this._sessionUuid}get initialSessionUuid(){return this._initialSessionUuid}get connectionStatus(){return this._connectionStatus}}var xe=i(77216),we=i(1795);class Ie{constructor(e,t=E.OB){this._staticCapiSettings=e,this._getEnv=t,this._subscriptions=[],this._connectionLevelSubscriptions=[],this._sessionUuid=y.h.create(f.YP),this._messages=new ne.xQ,this._logger=k.Y.create("StaticCheckingServiceImpl"),this._capi=new ve(this._staticCapiSettings.domain,this._staticCapiSettings.capiUrl,this._staticCapiSettings.supportedFeatures,this._staticCapiSettings.clientName,this._staticCapiSettings.clientSubType,this._staticCapiSettings.clientVersion,this._staticCapiSettings.useDlp,this._staticCapiSettings.startSessionOptions,this._getEnv),this.messages=this._messages.asObservable(),this.sessionUuid=this._sessionUuid.view(),this._initConnectionLevelListeners=()=>{this._connectionLevelSubscriptions.push(C.D(this._capi.getStatusObs()).pipe(le.B()).subscribe((e=>this._logger.info("CAPI API",e)))),this._connectionLevelSubscriptions.push(C.D(this._capi.getEventsObs()).pipe(le.B()).subscribe((e=>{switch(e.kind){case"session_started":this._messages.next({kind:we.jA.Kind.start,sessionUuid:we.hX.create(e.sessionUuid),isNewSession:e.isNewSession}),this._sessionUuid.set(f.G(we.hX.create(e.sessionUuid))),(0,s.zG)(this._sendContainerId(),he.Vn((e=>this._logger.warn("Could not send containerId to CAPI",e))))();break;case"error":this._messages.next({kind:we.jA.Kind.error,error:e.error,severity:e.severity});break;case"update_context_info_finished":this._messages.next({kind:we.jA.Kind.updateContextInfoFinished,updateContextInfoId:e.updateContextInfoId});break;case"doc_finished":this._messages.next({kind:we.jA.Kind.docFinished,updateContextInfoId:e.updateContextInfoId,docId:e.docId,features:new Set(e.features),failed:e.failed});break;case"reader_doc_info":case"reader_action_item":case"reader_main_point":case"reader_debug":case"reader_summary_item":case"reader_summary_finished":default:break;case"alert_received":{const t=(0,xe.IM)(e.alert,be.Q.fromString(e.alert.rev.toString())),i=(0,pe.VI)(t);this._messages.next({id:we.jA.KnowledgeHub.ItemId.create(e.alert.id),kind:we.jA.Kind.knowledgeHubItem,docId:e.alert.docId,updateContextInfoId:e.alert.updateContextInfoId,span:{s:t.highlightRanges[0].start,e:t.highlightRanges[0].end},termId:i.termId,headerText:i.headerText,headerIconSrc:f.ij(i.headerIconSrc),articleContent:i.articleContent,articleTitle:i.articleTitle,aliases:i.aliases,pointPeople:i.pointPeople,relatedMaterials:i.relatedMaterials,suggestCorrectionUrl:i.suggestCorrectionUrl,grammsUrl:i.grammsUrl});break}}})))},this._cleanConnectionLevelListeners=()=>{this._connectionLevelSubscriptions.forEach((e=>e.unsubscribe()))},this._subscriptions.push(this._messages.subscribe((e=>this._logger.debug("Received CAPI message",e)))),this._initConnectionLevelListeners(),this._subscriptions.push(this._capi.connectionStatus.subscribe((e=>this._handleConnectionStatus(e))))}updateContextInfo(e){return this._logger.debug("Received updateContextInfo command",{docId:e.docId}),this._capi.updateContextInfo(e)}sendKnowledgeHubFeedback(e){const t={id:we.jA.KnowledgeHub.ItemId.toAlertId(e.itemId),kind:Ce(e.kind)};this._capi.sendFeedback(t)}dispose(e){this._subscriptions.forEach((e=>e.unsubscribe())),this._connectionLevelSubscriptions.forEach((e=>e.unsubscribe())),this._logger.trace("Closing connection.",{reason:e}),this._capi.close(e)}_sendContainerId(){return(0,s.zG)((()=>this._getEnv().bgRpc.api.getContainerIdOrUndefined().then(ue.fromNullable(new Error("Got undefined containerId")))),he.UI((e=>()=>this._capi.setSessionOption({kind:ce.rP.GnarContainerId,id:e}))))}_handleConnectionStatus(e){switch(e){case me.QK.startingConnection:this._initConnectionLevelListeners();break;case me.QK.waitingForConnection:case me.QK.newSessionStarted:case me.QK.existingSessionStarted:break;case me.QK.waitingForReconnection:this._cleanConnectionLevelListeners();break;default:(0,ge.L0)(e)}}}function Ce(e){switch(e){case we.Lu.IGNORE:return ce.PZ.IGNORE;case we.Lu.LOOKED:return ce.PZ.LOOKED;default:return(0,ge.L0)(e)}}var Se=i(98107),ye=i(86399),ke=i(92135),Ee=i(87834),Ue=i(31413),Ne=i(53710),Re=i(66738),Oe=i(13195),Ae=i(85782),Ge=i(12171),ze=i(1941),Te=i(69715),Me=i(47344),Le=i(21147),Fe=i(58052),Pe=i(80144);const je=we.jA.isKnowledgeHub,qe=(e,t)=>(0,Me.Kg)(((e,t)=>(0,Me.W9)((0,Me.Kg)(je,we.jA.isDocFinished),(i=>i.updateContextInfoId===t&&i.docId===e)))(e,t),(e=>(0,Me.W9)(we.jA.isUpdateContextInfoFinished,(t=>t.updateContextInfoId===e)))(t));class De{constructor(e,t=k.Y.create("StaticChecksStateManagerImpl")){this._messages=e,this._logger=t,this._subscriptions=new o.w,this._updateRequests=new ne.xQ,this._checks=y.h.create(new Map),this._pendingUpdates=y.h.create(new Map),this._errors=y.h.create(new Map),this.checks=this._checks.view(),this.pendingUpdates=this._pendingUpdates.view(),this.errors=this._errors.view(),this._subscriptions.add(this._updateRequests.pipe(Oe.b((({docIds:e,updateContextInfoTask:t})=>l.of(...e.map((e=>({docId:e,updateContextInfoTask:t})))))),Ae.v((e=>e.docId)),Ge.zg(w.w((({docId:e,updateContextInfoTask:t})=>this._handleUpdateContextInfoTask(e,t))))).subscribe())}updateChecksState(e,t){(0,s.zG)(t,ue.fold((t=>this._updateRequests.next({docIds:e,updateContextInfoTask:Promise.resolve(ue.left(t))})),(t=>this._updateRequests.next({docIds:e,updateContextInfoTask:t}))))}dispose(){this._subscriptions.unsubscribe()}_handleUpdateContextInfoTask(e,t){return this._pendingUpdates.modify(te.EG(Ee.e.eq)(e)),(0,s.zG)(C.D(t),w.w(ue.fold((t=>(this._logger.warn(`Error getting checks for ${e}`,t),this._errors.modify(Ve(e,Re.ri("all"),t)),S.E)),(t=>(this._pendingUpdates.modify(te.ZQ(Ee.e.eq)(e,{updateContextInfoId:t,featureChecksCompleted:new Set})),this._handleUpdateContextInfoMessages(e,t))))))}_handleUpdateContextInfoMessages(e,t){return this._messages.pipe(p.h(qe(e,t)),ze.o((0,s.ff)(we.jA.isUpdateContextInfoFinished)),Te.x((()=>{this._pendingUpdates.modify(te.EG(Ee.e.eq)(e)),this._checks.modify((i=>{var n;return(null===(n=i.get(e))||void 0===n?void 0:n.updateContextInfoId)===t?i:(0,s.zG)(i,te.EG(Ee.e.eq)(e))}))})),x.b((0,s.ls)(f.DT(we.jA.isDocFinished),de.bw((({features:t,failed:i})=>this._featuresChecksCompleted(e,t,i))))),p.h(je),x.b((0,s.ls)(He,de.bw(this._insertCheck(e,t)))))}_insertCheck(e,t){return i=>this._checks.modify((0,Fe.n)(Ee.e.eq)(e,(e=>(0,s.zG)(e,f.g_((()=>({updateContextInfoId:t,checks:[i]})),(e=>({updateContextInfoId:t,checks:[...e.checks,i]})))))))}_featuresChecksCompleted(e,t,i){this._pendingUpdates.modify((i=>(0,s.zG)(i,te.cq(Ee.e.eq)(e,(e=>({updateContextInfoId:e.updateContextInfoId,featureChecksCompleted:Re.G0(Le.yv)(t,e.featureChecksCompleted)}))),f.fS((()=>i))))),i&&(this._logger.warn(`CAPI error gettings checks for ${[...t].join(", ")} - ${e}`),this._errors.modify(Ve(e,t,new Error(`CAPI failed getting checks for ${e}`))))}}function Ve(e,t,i){return(0,Fe.n)(Ee.e.eq)(e,f.g_((()=>new Map([...t].map((e=>[e,[i]])))),(e=>(0,s.zG)([...t],ye.u4(e,((e,t)=>(0,s.zG)(e,(0,Fe.n)(Pe.n.eq)(t,f.g_((()=>ye.of(i)),ye.QI(i))))))))))}function He(e){if(e.kind===we.jA.Kind.knowledgeHubItem)return f.G({kind:Pe.I.Kind.knowledgeHubItem,id:e.id,span:e.span,docId:e.docId,termId:e.termId,headerText:e.headerText,headerIconSrc:e.headerIconSrc,articleTitle:e.articleTitle,aliases:e.aliases,articleContent:e.articleContent,pointPeople:e.pointPeople,relatedMaterials:e.relatedMaterials,suggestCorrectionUrl:e.suggestCorrectionUrl,grammsUrl:e.grammsUrl});(0,ge.L0)(e.kind)}var Ke=i(18117),We=i(43223),Ye=i(25164);var Qe=i(73863),$e=i(97282),Be=i(42530);var Xe=i(1933),Ze=i(96030);class Je{constructor(e,t){var i;this._checkingService=e,this._threadContext=t,this._subscriptions=new o.w,this._optedIn=new Ue.t(1),this._staticChecksManager=new De(this._checkingService.messages),this.sessionUuid=this._checkingService.sessionUuid,this.checks=this._staticChecksManager.checks,this.pendingUpdates=this._staticChecksManager.pendingUpdates,this.errors=this._staticChecksManager.errors,this._subscriptions.add(this._threadContext.view((e=>new Set(e.messageIndexToIdMap.values()))).pipe((0,Xe.Gx)(this._optedIn.pipe(oe.x())),Ne.R(((e,t)=>new Set(Array.from(e).concat(Array.from(t)))),new Set),(i=Ee.e.eq,(0,s.ls)(_.O(new Set),Ze.G(),u.U((([e,t])=>Re.e5(i)(e)(t))),p.h((e=>e.size>0)))),function(e,t=0){return i=>{const n=new ne.xQ;return(0,s.zG)(i,Oe.b((e=>C.D(Array.from(e)))),Ge.zg((t=>e.pipe(u.U((e=>(0,s.zG)(f.ij(e.expandedMessages.get(t)),f.g_(s.jv,We.d6)))),p.h(Be.fQ),Qe.q(1),m.h(t)))),x.b((()=>n.next())),$e.R((()=>n.pipe(h.b(t)))),u.U((e=>new Set(e))),p.h((e=>e.size>0)))}}(this._threadContext),u.U((e=>(0,s.zG)([...e],ye.UI((e=>(0,s.zG)(function(e,t){return(0,s.zG)(ue.fromNullable(new Ye.Pi(`message ${e} is not expanded`))(t.expandedMessages.get(e)),ue.chain((t=>We.d6(t)?ue.right(t.value):ue.left(new Ye.Pi(We.IR(t)?t.error.message:`message ${e} not extracted`)))),ue.chain((e=>Ke.Yt(ue.either)({containerType:ue.right("email"),docId:ue.right(e.id),title:t.subject,delta:ue.right(e.textMap.getRichText()),siblingIndex:ue.right(e.index),authors:(0,s.zG)(t.loggedUser,ue.map((t=>[{email:e.context.author.email,name:e.context.author.name,currentSessionUser:e.context.author.email===t.email}]))),audience:(0,s.zG)(t.loggedUser,ue.map((t=>e.context.audience.map((e=>({email:e.email,name:e.email,currentSessionUser:e.email===t.email}))))),ue.chain((e=>Ke.Yt(ue.either)({recipients:ue.right(e),channelId:t.threadId,channelName:t.subject})))),metadata:ue.right({email:e.context.metadata})}))))}(e,this._threadContext.get()),ue.mapLeft((t=>this._staticChecksManager.updateChecksState([e],ue.left(t)))),f.Uo))),ye.oA,ke.c2,f.UI((e=>({docIds:(0,s.zG)(e,ke.UI((e=>e.docId))),docInfo:{...e[0],siblings:e.slice(1)}})))))),I.oA).subscribe((({docIds:e,docInfo:t})=>this._staticChecksManager.updateChecksState(e,ue.right(this._checkingService.updateContextInfo(t))))))}sendKnowledgeHubFeedback(e){this._checkingService.sendKnowledgeHubFeedback(e)}dataOptIn(e){this._optedIn.next(e)}dispose(){this._subscriptions.unsubscribe(),this._staticChecksManager.dispose()}}var et,tt=i(48822),it=i(26488),nt=i(11946),st=i(49231),ot=i(14944),rt=i(43818),at=i(8609),dt=i(72521),ct=i(8902),lt=i(98547),ht=i(46356),ut=i(66241),gt=i(72616),pt=i(31584),mt=i(89225),_t=i(62215),ft=i(75457);function bt(e,t,i,n=!1,s=!1){const o=(0,P.Me)(e).body,r=(0,P.Jj)(e);let a={left:"0px",top:"0px"};if(t.fieldPaintingPositioning===mt.Q.nonPositioned&&t.positionedAncestor===o){const e=r.getComputedStyle(o);a={left:e.marginLeft||"0px",top:e.marginRight||"0px"}}else if(t.positionedAncestor!==o){const e=r.getComputedStyle(t.positionedAncestor);a={left:e.borderLeftWidth&&`-${e.borderLeftWidth}`||"0px",top:e.borderTopWidth&&`-${e.borderTopWidth}`||"0px"}}return o=>{o.style.position="absolute",o.style.top=a.top,o.style.left=n?"auto":a.left,s||(o.style.right=n?a.left:"auto",o.style.pointerEvents="none"),function({subjectElement:e,isPositioned:t,subjectElementStyle:i,integrationRoot:n,positionedAncestor:s}){t?(n.style.zIndex=i.zIndex,e.insertAdjacentElement("afterend",n)):s.insertAdjacentElement("afterbegin",n)}({subjectElement:e,isPositioned:t.fieldPaintingPositioning===mt.Q.positioned,subjectElementStyle:i,integrationRoot:o,positionedAncestor:t.positionedAncestor})}}function vt(e){return dt.Pf.create({...e.client,...e.size})}class xt{constructor(e,t=!1,i){this._highlightsSubject=e,this._innerElementsInteractive=t,this._subscriptions=new o.w,this._mouse=y.h.create({offset:null,client:null}),this._fakeMouse=y.h.create(null),this._prepareHighlights=(e,t=(0,P.is)(e))=>{const i=(0,P.o)(e),n=(0,_t.fL)(e,!1,i,t);return{layout:n,rootInjector:bt(e,n,i)}},this._prepareInnerElements=(e,t=(0,P.is)(e),i)=>{const n=(0,P.o)(e),s=i||(0,_t.fL)(e,!1,n,t);return{layout:s,rootInjector:bt(e,s,n,!0,this._innerElementsInteractive)}},this._highlights=this._prepareHighlights(this._highlightsSubject),this._innerElements=this._prepareInnerElements(this._highlightsSubject,void 0,this._highlights.layout),this._win=(0,P.Jj)(this._highlightsSubject),this._createTextNodeRect=e=>({page:M.Cv.fromClient(e.client,{top:this._win.scrollY,left:this._win.scrollX}),offset:e.offset,client:e.client,size:e.size,padding:e.padding}),this.textNode={rect:this._highlights.layout.textField.paddingRect.map(this._createTextNodeRect),visibleRect:this._highlights.layout.textField.visibleRect.map(this._createTextNodeRect),scroll:this._highlights.layout.textField.scroll,scrollSize:this._highlights.layout.textField.scrollSize,scroller:(0,L.iX)(this._highlightsSubject,{rect:this._highlights.layout.textField.paddingRect.map(this._createTextNodeRect),scrollSize:this._highlights.layout.textField.scrollSize})},this.highlightHeightOffset=0,this.mouse=y.h.combine(this._mouse,this._fakeMouse,((e,t)=>t||e)),this._subscriptions.add(c.aj([this._highlights.layout.textField.paddingRect.behavior,this._highlights.layout.textField.scroll.behavior]).pipe((0,u.U)((([e,t])=>({rect:vt(e),scroll:t}))),(0,w.w)((({rect:e,scroll:t})=>(0,O.Am)()?(0,lt.q7)(this._win,e,t):(0,lt.B0)(this._win,e,t))),(0,oe.x)(Be.fS)).subscribe(pt.wW(this._mouse))),i&&this._subscriptions.add(c.aj([this._highlights.layout.textField.paddingRect.behavior,this._highlights.layout.textField.scroll.behavior]).pipe((0,u.U)((([e,t])=>({rect:vt(e),scroll:t}))),(0,w.w)((({rect:e,scroll:t})=>i.pipe(u.U((i=>{if(i){const n=M.Ir.create({left:i.clientX,top:i.clientY});return{client:n,offset:dt.UL.contains(n,e)?M.p8.fromClientPoint(n,e,t):null}}return null}))))),(0,oe.x)(Be.fS)).subscribe(pt.wW(this._fakeMouse)))}createGeometryLayout(){return new ct.D((()=>vt(this._highlights.layout.textField.paddingRect.getCurrent())),(()=>this._highlights.layout.textField.scroll.getCurrent()),(()=>vt(this._highlights.layout.textField.paddingRect.getApproximate())),(()=>this._highlights.layout.textField.scroll.getApproximate()))}render(e,t){var i;const n=(0,P.Me)(this._highlightsSubject),s=null!==(i=t.highlightsLayoutMargin)&&void 0!==i?i:0,o=e.highlights&&ht.V.get({monitorAs:"highlights"}).inject(ut.EM.fromDocument(n,"grammarly-extension"),(e=>{this._highlights.rootInjector(e)}),gt.G7.showWhenLoaded(st.createElement("div",{"data-grammarly-part":"highlights",style:{position:"absolute",top:0,left:0}},st.createElement(ft.V,{layout:this._highlights.layout,margin:s},st.createElement(rt.F.div,{style:this.textNode.scrollSize.behavior.pipe(u.U((e=>({position:"absolute",height:e.height,width:e.width,top:s,left:s}))))},st.createElement(e.highlights,null)))))),r=e.innerElements&&ht.V.get({monitorAs:"inner-elements"}).inject(ut.EM.fromDocument(n,"grammarly-extension"),this._innerElements.rootInjector,gt.G7.showWhenLoaded(st.createElement("div",{"data-grammarly-part":"inner-elements",style:{position:"absolute",top:0,right:0}},st.createElement(at.Lm,null),st.createElement(e.innerElements,null)))),a=e.outerElements&&ht.V.get({monitorAs:"outer-elements"}).inject(ut.EM.fromDocument(n,"grammarly-extension"),ut.zs.appendChild(n.documentElement),gt.G7.showWhenLoaded(st.createElement(e.outerElements,null)),{eventPropagationHandler:t.eventPropagationHandler});return{dispose:()=>{null==o||o.dispose(),null==a||a.dispose(),null==r||r.dispose()}}}dispose(){this._subscriptions.unsubscribe()}}!function(e){e.ord=ot.Uz((e=>e.order))(ot.Mh)}(et||(et={}));class wt{constructor(e,t,i,n){this._docId=e,this._docNode=t,this._textMap=i,this._mouseOverride=n,this._views=new Map,this._rootView=null}addAnnotationsViewFactories(e){this._rootView=this._rootView||this._createRootView();for(const[t,i]of e){const e=i(this._docId,this._docNode,this._textMap,this._rootView.layout);this._views.set(t,e),this._rootView.cards.modify((i=>i.concat({id:t,view:e.cardsUI}))),this._rootView.highlights.modify((i=>i.concat({id:t,view:e.highlightsUI,order:e.highlightsLayerOrder})))}}removeAnnotationsView(e){var t;this._rootView&&(this._rootView.cards.modify(ye.hX((t=>t.id!==e))),this._rootView.highlights.modify(ye.hX((t=>t.id!==e)))),null===(t=this._views.get(e))||void 0===t||t.dispose(),this._views.delete(e),0===this._views.size&&this._clearRootView()}dispose(){this._views.forEach((e=>e.dispose())),this._clearRootView()}_clearRootView(){this._rootView&&(this._rootView.renderResult.dispose(),this._rootView.layout.dispose(),this._rootView=null)}_createRootView(){var e;const t=new xt(this._docNode,!0,null===(e=this._mouseOverride)||void 0===e?void 0:e.pipe(u.U(f.WG))),i=y.h.create([]),n=y.h.create([]);return{cards:i,highlights:n,layout:t,renderResult:t.render({highlights:()=>st.createElement(rt.F.Fragment,null,n.view((0,s.ls)(ye.DY(et.ord),ye.UI((({id:e,view:t})=>st.createElement(t,{key:e})))))),outerElements:()=>st.createElement(rt.F.Fragment,null,i.view(ye.UI((({id:e,view:t})=>st.createElement(t,{key:e})))))},{highlightsLayoutMargin:0})}}}var It,Ct=i(35312),St=i(16925),yt=i(22639),kt=i(4582),Et=i(91486),Ut=i(69773);class Nt{constructor(e=!0){this._collateLines=e}create(e,t){return{getRects:()=>{var i;const n=[];let o,r=e.start,a=!1;do{const s=t.getFragmentAtOrBeforeOffset(r);if(s&&o!==r){o=r;if(null===(i=s.node.textContent)||void 0===i?void 0:i.replace(/\s/g,"")){const i=Ut.M.createRange(t,r,Math.min(s.endOffset,e.end));i&&n.push(...Array.from(i.getClientRects()))}r=s.endOffset===r?s.endOffset+1:s.endOffset}else a=!0}while(r<e.end&&!a);return(0,_e.zG)(n,Et.es,this._collateLines?Et.yX:s.yR,re.UI(dt.Pf.create))}}}getClientRects(e){return e.getRects()}getIsInvalid(e){return!1}getIsConsistent(e,t,i){return!0}dispose(e){}}function Rt(e,t,i,n,o,r,a){const d=new Nt(!1),c=new yt.C(d,n.createGeometryLayout(),(()=>r),(0,St.u)(),(0,kt.WF)(n.textNode)),l=new Map,h=t.pipe(function(e){return(0,s.ls)(u.U(te.P5(Ee.e.eq)(e)),_.O(f.YP),Ze.G(),u.U((([e,t])=>(0,s.zG)(t,f.UI((t=>{const{removed:i,added:n}=function(e,t){const{left:i,right:n}=(0,s.zG)(it.yi(Ct.q.eq)(new Map(e.map((e=>[e.id,e]))),new Map(t.map((e=>[e.id,e])))),nt.v.reduce({left:[],right:[]},((e,t)=>({...e,left:e.left.concat(t)})),((e,t,i)=>({left:e.left.concat(t),right:e.right.concat(i)})),((e,t)=>({...e,right:e.right.concat(t)}))));return{removed:i,added:n}}((0,s.zG)(e,f.fS((()=>[]))),t);return{kind:"update",annotations:t,removed:i,added:n}})),f.Gk((()=>(0,s.zG)(e,f.UI((e=>({kind:"allRemoved",removed:e}))))))))),I.oA)}(e)).subscribe((t=>{if("allRemoved"===t.kind)c.removeHighlights(Array.from(l.values())),l.clear(),a.trace(`Annotations for ${e} cleared`);else if("update"===t.kind){const e=(0,s.zG)(t.removed,ye.UI((e=>e.id)),ye.u4([],((e,t)=>(0,s.zG)(l,te.P5(Ct.q.Id.eq)(t),f.g_((()=>e),(i=>(l.delete(t),e.concat(i))))))));e.length>0&&(c.removeHighlights(e),a.trace("Removed annotation highlights",e));const i=t.added.map((e=>{const t=kt.y$.Id.create(e.id);return l.set(e.id,t),c.addHighlight(t,{start:e.span.s,end:e.span.e},{highlightId:t,annotation:e,highlightColor:null,highlightDisplayFormat:null,highlightLiveliness:null,alertId:""}),t}));i.length>0&&a.trace("Added annotation highlight",i)}else(0,ge.L0)(t)})),g=i({docId:e,docNode:o,docLayout:n,highlightsCollection:c});return{highlightsLayerOrder:g.highlightsLayerOrder,highlightsUI:g.highlightsUI,cardsUI:g.cardsUI,dispose:()=>{g.dispose(),h.unsubscribe(),c.dispose(),a.trace("Annotations view disposed")}}}!function(e){e.eq=Le.Uz((e=>({docId:e.docId,textNode:e.textNode})))(Le.MW({docId:Ee.e.eq,textNode:Ye.EN.eq}))}(It||(It={}));class Ot{constructor(e,t,i=k.Y.create("gmail.annotationsManager")){this._messagesRoot=t,this._logger=i,this._subscriptions=new tt.L,this._nodesAndIntegrations=new Map,this._annotationsViewsFactories=new Map,this._textNodeToDocId=new WeakMap,this._hiddenDocs=new WeakMap,this._nodeChangesOverride=new ne.xQ,this._intersectionObserver=this._initIntersectionObserver(),this._mouseOverride=new ie.X(f.YP),this._subscriptions.add(a.T(e.pipe((0,s.ls)(_.O(new Map),Ze.G(),u.U((([e,t])=>(0,s.zG)(it.yi(It.eq)(e,t),nt.v.reduce([],((e,{docId:t})=>e.concat({kind:"remove",docId:t})),((e,t,i)=>Ye.EN.eq.equals(t.textNode,i.textNode)?e:e.concat({kind:"remove",docId:t.docId},{kind:"add",...i})),((e,t)=>e.concat({kind:"add",...t})))))),Ge.zg(s.yR))),this._nodeChangesOverride).subscribe((e=>{if("remove"===e.kind)(0,s.zG)(f.ij(this._nodesAndIntegrations.get(e.docId)),de.bw((e=>{e.integration.dispose(),this._textNodeToDocId.delete(e.textNode.node),this._intersectionObserver.unobserve(e.textNode.node)}))),this._nodesAndIntegrations.delete(e.docId),this._logger.trace(`Annotation integrations for ${e.docId} cleared`);else if("add"===e.kind){const t=new wt(e.docId,e.textNode.node,e.textMap,this._mouseOverride);t.addAnnotationsViewFactories(this._annotationsViewsFactories),this._nodesAndIntegrations.set(e.docId,{docId:e.docId,textMap:e.textMap,textNode:e.textNode,integration:t}),this._textNodeToDocId.set(e.textNode.node,e.docId),this._intersectionObserver.observe(e.textNode.node)}else(0,ge.L0)(e)})))}createIntegration(e){const t=Be.iy.create(),i=(t,i,n,s)=>Rt(t,e.annotations,e.createAnnotationsView,s,i,n,this._logger);this._annotationsViewsFactories.set(t,i),this._nodesAndIntegrations.forEach((({integration:e})=>e.addAnnotationsViewFactories(new Map([[t,i]]))));const n=(e.mouseOverride||S.E).subscribe((e=>{this._mouseOverride.next(e)}));return{dispose:()=>{n.unsubscribe(),this._nodesAndIntegrations.forEach((({integration:e})=>e.removeAnnotationsView(t))),this._annotationsViewsFactories.delete(t)}}}_initIntersectionObserver(){return new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting?(0,s.zG)(f.ij(this._hiddenDocs.get(e.target)),de.bw((t=>{this._logger.debug(`Message ${t.docId} visible, restoring annotation integrations`),this._hiddenDocs.delete(e.target),this._nodeChangesOverride.next({kind:"add",...t})}))):(0,s.zG)(f.ij(this._textNodeToDocId.get(e.target)),f.tS((e=>f.ij(this._nodesAndIntegrations.get(e)))),de.bw((({docId:t,textNode:i,textMap:n})=>{this._logger.debug(`Message ${t} hidden, clearing annotation integrations`),this._nodeChangesOverride.next({kind:"remove",docId:t}),this._hiddenDocs.set(e.target,{docId:t,textNode:i,textMap:n}),this._intersectionObserver.observe(i.node)})))}))}),{root:this._messagesRoot})}dispose(){this._subscriptions.unsubscribe(),this._intersectionObserver.disconnect(),this._nodesAndIntegrations.forEach((({integration:e})=>e.dispose())),this._nodesAndIntegrations.clear(),this._annotationsViewsFactories.clear()}}var At,Gt,zt,Tt=i(88686),Mt=i(99793),Lt=i(86185),Ft=i(29682);!function(e){e.empty=function(){return{messages:new Map,added:new Set,updated:new Set,removed:new Set}}}(At||(At={})),function(e){e.isExpanded=function(e){return f.pC(e.bodyNode)&&f.pC(e.id)}}(Gt||(Gt={})),function(e){e.eqByBodyNodeAndRev=Le.Uz(ae.ei("bodyNode"))(f.Eh(Ye.EN.eq))}(zt||(zt={}));class Pt{constructor(e,t=k.Y.create("gmail.expandedMessages")){var i;this._messageList=e,this._logger=t,this._messageCount=y.h.create(qt(this._messageList).length),this.messageCount=this._messageCount.view(),this.expandedMessages=(i=this._messageList,new r.y((e=>{const t=new o.w,n=new Map,a=new ie.X(new Map),d=new ne.xQ,c=new IntersectionObserver((e=>e.forEach((e=>{e.isIntersecting||d.next(e.target)}))),{root:null});return t.add($.x.create(i,{childList:!0}).pipe(u.U((e=>({added:e.flatMap((e=>Array.from(e.addedNodes))).filter(Dt),removed:e.flatMap((e=>Array.from(e.removedNodes))).filter(Dt)}))),_.O({added:qt(i),removed:new Array})).subscribe((({added:e,removed:t})=>{t.forEach((e=>{var t;null===(t=n.get(e))||void 0===t||t.unsubscribe(),a.next((0,s.zG)(te.EG(Le.w4)(e)(a.value),jt(i)))})),e.forEach((e=>{var t;null===(t=n.get(e))||void 0===t||t.unsubscribe();const h=function(e,t,i){return new r.y((n=>{const r=new o.w,a=new ie.X({bodyNode:(0,s.zG)(Vt(i),f.UI((e=>({node:e,rev:0})))),id:Ht(i)});return f.Wi(a.value.bodyNode)&&r.add($.x.create(i,{attributes:!0,attributeFilter:["aria-expanded","tabindex"]}).pipe(u.U((()=>Vt(i))),I.oA,Qe.q(1)).subscribe((e=>a.next({bodyNode:f.G({node:e,rev:0}),id:(0,s.zG)(a.value.id,f.wp((()=>Ht(i))))})))),r.add(a.subscribe((({bodyNode:t,id:i})=>{(0,s.zG)(t,de.bw((t=>e.observe(t.node)))),n.next({bodyNode:t,id:i})}))),r.add(t.pipe(p.h((e=>(0,s.zG)(a.value.bodyNode,f.UI((e=>e.node)),de.FX(e))&&!document.contains(e)))).subscribe((t=>{e.unobserve(t),a.next({bodyNode:(0,s.zG)(Vt(i),f.UI((e=>({node:e,rev:0})))),id:a.value.id})}))),()=>r.unsubscribe()})).pipe(w.w((({bodyNode:e,id:t})=>(0,s.zG)(e,f.g_((()=>l.of({bodyNode:f.YP,id:t})),(e=>$.x.create(e.node,{subtree:!0,childList:!0,attributes:!1,characterData:!0}).pipe(Ne.R((e=>e+1),e.rev),_.O(0),u.U((i=>({bodyNode:f.G({node:e.node,rev:i}),id:t}))))))))))}(c,d,e).pipe(_.O({bodyNode:f.YP,id:f.YP}),Ze.G()).subscribe((([{bodyNode:t},{bodyNode:n,id:o}])=>{f.pC(t)&&f.Wi(n)?a.next((0,s.zG)(te.EG(Le.w4)(e)(a.value),jt(i))):a.next((0,s.zG)(a.value,te.cq(Le.w4)(e,(e=>({...e,bodyNode:n,id:o}))),f.fS((()=>te.ZQ(Le.w4)(e,{messageNode:e,bodyNode:n,id:o,index:a.value.size})(a.value)))))}));n.set(e,h)}))}))),t.add(a.subscribe((t=>e.next(t)))),()=>{t.unsubscribe();for(const e of n.values())e.unsubscribe();c.disconnect()}}))).pipe(x.b((e=>this._messageCount.set(e.size))),Tt.e(50),x.b((e=>this._logger.debug("message nodes map updated",e))),u.U(te.hX(Gt.isExpanded)),Mt.shareReplay({bufferSize:1,refCount:!0}),_.O(te.cS),Ze.G(),u.U((([e,t])=>function(e,t){return(0,s.zG)(it.yi(zt.eqByBodyNodeAndRev)(e,t),nt.v.reduce({messages:new Map(Array.from(t.values()).map((e=>[e.id.value,{...e,id:e.id.value,bodyNode:e.bodyNode.value}]))),added:new Set,updated:new Set,removed:new Set},((e,t)=>({...e,removed:e.removed.add(t.id.value)})),((e,t,i)=>({...e,updated:e.updated.add(i.id.value)})),((e,t)=>({...e,added:e.added.add(t.id.value)}))))}(e,t))))}}function jt(e){const t=new Map(qt(e).map(((e,t)=>[e,t])));return e=>(0,s.zG)(e,te.Su(((e,i)=>(0,s.zG)(f.ij(t.get(e)),f.g_((()=>i),(e=>({...i,index:e})))))))}function qt(e){return Array.from(e.children).filter(Dt)}function Dt(e){return e instanceof HTMLDivElement&&(e.matches("[aria-expanded]")&&!!e.innerText||!e.matches("[aria-expanded]"))}function Vt(e){return(0,s.zG)(f.ij(e.querySelector(Ft.xR)),f.hX(Lt.Re))}function Ht(e){var t,i;return f.ij(null===(i=null===(t=e.querySelector(Ft.k2))||void 0===t?void 0:t.getAttribute(Ft.bq))||void 0===i?void 0:i.slice(1))}var Kt=i(91368);var Wt,Yt,Qt,$t=i(34379),Bt=i(67223),Xt=i(70163),Zt=i(64218),Jt=i(78008),ei=i(11633),ti=i(4463);!function(e){e.codec=ei.UQ(ei.Z_,(e=>"string"==typeof e&&e.trim().length>0),"LinkMIMEType"),e.create=function(t){return t?(0,s.zG)(e.codec.decode(t),f.Uo):f.YP}}(Wt||(Wt={})),function(e){e.codec=ei.UQ(ei.Z_,(e=>"string"==typeof e&&e.trim().length>0),"LinkURL"),e.create=function(t){return t?(0,s.zG)(e.codec.decode(t),f.Uo):f.YP},e.eq=Le.yv}(Yt||(Yt={})),function(e){e.hyperlink="hyperlink",e.email="email",e.attachment="attachment"}(Qt||(Qt={}));const ii=ei.OT(ei.dt({name:ei.Z_,url:Yt.codec,type:ti.D.createStringEnum(Qt,"mailLinkType")})),ni=ei.jV([ii,ei.OT(ei.dt({type:ei.i0(Qt.email)}))]),si=ei.jV([ii,ei.OT(ei.dt({type:ei.i0(Qt.hyperlink)}))]),oi=ei.jV([ii,ei.OT(ei.dt({type:ei.i0(Qt.attachment)})),ei.OT(ei.r$({mimeType:Wt.codec}))]);var ri;!function(e){e.isAttachment=e=>e.type===Qt.attachment,e.codec=ei.G0([ni,si,oi])}(ri||(ri={}));var ai=i(12532);function di(e){const t=[];e.querySelectorAll("table").forEach((e=>{0!==t.length&&t[t.length-1].contains(e)||t.push(e)}));const i=e.innerText.replace(/\s+/g,""),n=t.map((e=>e.innerText.replace(/\s+/g,"")));let s=i;for(const e of n)s=s.replace(e,"");const o=Math.max(0,Math.min(1,(i.length-s.length)/i.length));return Number.isNaN(o)?void 0:o}function ci(e,t,i){return n=>new r.y((o=>{const r=n.pipe(Bt.u(),u.U((e=>({message:e}))),Xt.B()).pipe(Ae.v((e=>e.message.id)),Ge.zg((i=>i.pipe(w.w((i=>function(e,t,i){var n;const o=(0,s.zG)(ue.fromNullable(new Ye.Pi("No message date found"))(null===(n=t.messageNode.querySelector(Ft.ms))||void 0===n?void 0:n.getAttribute("title")),ue.map((t=>(0,s.zG)(new Date(t),(i=>{var n;return Number.isNaN(i.valueOf())?{kind:"unparsedDate",date:t,locale:(null===(n=e.querySelector(Ft.Gg))||void 0===n?void 0:n.getAttribute(Ft.sC))||void 0}:{kind:"parsedDate",timestamp:i.getTime()}}))))),r=(0,s.zG)(ue.fromNullable(new Ye.Pi("No message author found"))(t.messageNode.querySelector(Ft.OL)),ue.chain(li)),a=(0,s.zG)(ue.fromNullable(new Ye.Pi("No <to> field found in message"))(t.messageNode.querySelectorAll(Ft.VN)),ue.chain((e=>(0,s.zG)(Array.from(e),re.UI(li),re.IX.sequence(ue.either),ue.chain((0,s.ls)(ke.nI,ue.fromOption((()=>new Ye.Pi("No audience found"))))))))),d=(0,s.zG)(t.messageNode.querySelector(Ft.hZ),(e=>ue.right(!!e)));return c.aj([l.of({date:o,author:r,audience:a,hasListUnsubscribeLink:d}),i(t.messageNode)]).pipe(u.U((([{date:e,author:i,audience:n,hasListUnsubscribeLink:s},o])=>Ke.Yt(ue.either)({date:e,author:i,audience:n,links:ue.right(o),hasListUnsubscribeLink:s,tableTextCoverage:ue.right(di(t.bodyNode.node))}))))}(e,i.message,t).pipe(u.U((e=>({...i,messageId:i.message.id,domContext:e}))),function(e,t=6e3){return i=>i.pipe((0,Xe.Vh)(t),Zt.K((t=>l.of(e(t)))))}((e=>({...i,messageId:i.message.id,domContext:ue.left(new Ye.Pi("DOM extraction timeout"+((0,ai.H)(e)?` [${e.message}]`:"")))}))),u.U((e=>({...e,type:"fromDOM"}))))))))),x.b((e=>(0,s.zG)(e.domContext,ue.fold((t=>i.warn(`DOM context extraction error for ${e.messageId}`,t)),(t=>i.trace(`DOM context extracted for ${e.messageId}`,t)))))),Xt.B()),a=r.pipe(u.U((e=>({message:e.message,context:(0,s.zG)(e.domContext,ue.map((e=>({author:e.author,audience:e.audience,date:e.date,links:e.links,metadata:{tableTextCoverage:e.tableTextCoverage,listUnsubscribe:e.hasListUnsubscribeLink?["has-unsubscribe-link"]:void 0,replyTo:void 0,contentType:void 0}}))))}))),x.b((e=>(0,s.zG)(e.context,ue.fold((t=>i.warn(`Context extraction error for ${e.message.id}`,t)),(t=>i.info(`Context extracted for ${e.message.id}`,t))))))).subscribe((e=>o.next(e)));return()=>a.unsubscribe()}))}function li(e){return Ke.Yt(ue.either)({email:(0,s.zG)(ue.fromNullable(new Ye.Pi("No email found"))(null==e?void 0:e.getAttribute("email")),ue.chain((e=>ue.fromOption((()=>new Ye.Pi("Invalid email address")))($t.G.create(e))))),name:(0,s.zG)(ue.fromNullable(new Ye.Pi("No name found"))(null==e?void 0:e.getAttribute("name")),ue.map((e=>e||void 0)))})}function hi(e){return(0,s.zG)(Array.from(e.querySelectorAll(Ft.rf)),re.DZ((0,s.ls)(f.DT((e=>!e.closest(Ft.A4)&&!e.matches(Ft.wJ))),f.tS((e=>(0,s.zG)(Yt.create(e.getAttribute("href")),f.UI((t=>({url:t,name:(0,s.zG)(f.ij(e.getAttribute("aria-label")),f.fS((()=>e.innerText.trim()))),type:t.startsWith("mailto:")?Qt.email:Qt.hyperlink})))))))))}function ui(e){return(0,s.zG)(f.ij(e),f.tS((e=>f.ij(/^([^:]+):([^:]+):(https?:\/\/.+)?(https?:\/\/.+)$/.exec(e)))),f.tS((([e,t,i,n,o])=>(0,s.zG)(Yt.create(o),f.UI((e=>({name:decodeURIComponent(i),url:e,type:Qt.attachment,mimeType:f.FS(Wt.create(t))})))))))}function gi(e){return(0,s.zG)(Yt.create(e.getAttribute("href")),f.UI((t=>{var i;return{name:e.getAttribute("data-tooltip")||(null===(i=e.querySelector("div"))||void 0===i?void 0:i.innerText)||e.innerText,url:t,type:Qt.attachment,mimeType:void 0}})))}function pi(e){return c.aj([l.of(hi(e)),(0,s.zG)(Array.from(e.querySelectorAll(Ft.Mz)).map((e=>function(e,t=4e3){return(0,s.zG)(e.getAttribute("href")||"",f.DT((e=>!/^https?:\/\/docs\.google\.[^./]+\//.test(e))),f.UI((i=>new r.y((t=>{var i;(0,s.zG)(f.ij(null===(i=e.parentElement)||void 0===i?void 0:i.getAttribute("download_url")),f.hX((e=>!!e)),f.g_((()=>t.error("Attachment not found")),(()=>{t.next(!0),t.complete()})))})).pipe((0,Xe.WV)(t/200,200),Jt.V(t),Zt.K((()=>l.of(!1))),u.U((t=>{var i;return(0,s.zG)(f.ij(null===(i=e.parentElement)||void 0===i?void 0:i.getAttribute("download_url")),f.tS(ui),f.wp((()=>gi(e))))}))))),f.fS((()=>l.of(gi(e)))),I.oA)}(e))),(e=>e.length>0?c.aj(e):l.of([])))]).pipe(u.U((([e,t])=>Array.from(e.concat(t).reduce(((e,t)=>e.set(t.url,t)),new Map).values()))))}var mi=i(37035);class _i extends Se.J{constructor(e,t,i,n,a=E.OB,c=(0,X.Tb)(),g=k.Y.create("gmail.threadContext.pageIntegration")){const p=new ie.X(f.YP),b=(0,s.zG)(n,re.DZ((e=>e(p))));super(...b.map((e=>e.integration))),this._state=e,this._pageIntegrationContext=t,this._getEnv=a,this._telemetry=c,this._logger=g,this._subscriptions=new o.w,this._userChanged=new ne.xQ;const v=b.some((e=>e.extractLinks));this._subscriptions.add((b.length>0?d.R((0,P.Jj)(this._pageIntegrationContext.doc.documentElement),"popstate").pipe(_.O(null),se.g(50),w.w((()=>function(e,t){const i=new ne.xQ;return i.pipe(_.O(null),w.w((()=>new r.y((i=>{t.trace("trying to find message list node");const n=e.querySelector(Ft.bK);n?(t.debug("message list found",n),i.next(n)):i.error("Message list not found")})).pipe((0,Xe.yF)(10,100,(()=>S.E)),oe.x(),w.w((n=>Kt.n(n,{root:e}).pipe(u.U((e=>{const n=e.every((e=>e.isIntersecting));return n||(t.debug("message list disappeared"),i.next()),n})),ze.o((e=>!0===e)),m.h(n)))),oe.x()))))}(this._pageIntegrationContext.doc,this._logger).pipe(_.O(null)))),h.b(50),oe.x(),u.U(f.ij),w.w(f.g_((()=>l.of(f.YP)),(e=>new r.y((t=>{const n=()=>function(e,t,i,n,o,r){const a=new Pt(e),d=k.Y.create("gmail.threadContext"),c=ci(t.doc,i?pi:()=>l.of([]),d),h=new mi.x(t.doc,a,c,r,d),u=(0,Be.Vo)((()=>(0,s.zG)(new Ie({domain:t.domain,capiUrl:t.config.appConfig.url.capiStatic,supportedFeatures:n(),clientName:t.config.appConfig.capi.clientType,clientSubType:t.config.appConfig.capi.clientSubType,clientVersion:t.config.buildInfo.version,useDlp:Boolean(t.dynamicConfig.dlpEnabled)},o),(e=>({checkingService:e,adapter:new Je(e,h.threadContext)}))))),g=new Ot((0,s.zG)(h.threadContext.view((0,s.ls)(ae.ei("expandedMessages"),te.DZ((0,s.ls)(de.xC,f.UI((e=>({docId:e.id,textMap:e.textMap,textNode:e.bodyNode})))))))),e);return{integrationContext:{messageList:e,threadContext:h.threadContext,expandedMessages:a.expandedMessages,checkingService:u.map((e=>e.adapter)),annotationsManager:g},dispose:e=>{h.dispose(),g.dispose(),u.hasValue&&(u.get().adapter.dispose(),u.get().checkingService.dispose(e))}}}(e,this._pageIntegrationContext,v,i,this._getEnv,this._telemetry),o=new ie.X(n()),r=[this._userChanged.subscribe((()=>{o.value.dispose("User changed"),o.next(n())})),o.pipe(u.U((e=>f.G(e.integrationContext)))).subscribe(t)];return()=>{r.forEach((e=>e.unsubscribe())),o.value.dispose("Disposed")}})))))):S.E).subscribe(p)),this._logger.debug("Page integration created")}update(e){e.user.id===this._state.user.id&&e.user.type===this._state.user.type||this._userChanged.next(null),this._state=e,super.update(e)}dispose(){this._subscriptions.unsubscribe(),super.dispose(),this._logger.debug("Page integration disposed")}}var fi,bi=i(3785);!function(e){let t;const v={cheetahOverflowCustomCaret:!0,cheetahEnableQuickReplies:!0};function x(e,n,s,a,d){if(j.d.shouldCreate(a.config.bundleInfo.browser,a.domain,s.dynamicConfig,s.user)){const s=new o.w;return new r.y((o=>{o.next(null),i.e(4100).then(i.bind(i,89182)).then((({ProofitGmailInProgressRequestTracker:i,ProofitGmailIntegrationForComposeWindow:r,ProofitGmailIntegrationForThreads:a})=>{t||(t=new i);const c=new("composeWindow"===d?r:a)(e,n,t);return o.next(c.getProofitLayout()),s.add($.x.observeStyle(e).pipe((0,h.b)(200),(0,u.U)((()=>c.getProofitLayout()))).subscribe((e=>o.next(e)))),()=>s.unsubscribe()}))})).pipe((0,g.d)())}}const w=e=>!!e.state.dynamicConfig.confidentialModeEnabled&&bi.x.isInConfidentialMode(e.field),I=e=>()=>(0,a.T)((0,d.R)(e.field,"focus").pipe((0,p.h)((()=>w(e)))),(0,D.Jj)(e.field)).pipe((0,m.h)(void 0)),C=(e,t)=>q.T.contentEditable("Gmail.compose",(i=>{const n=bi.x.getComposeFieldContainer(i.field);return{integrationName:t,extraCondition:t=>e(t.field)&&!w(t),expiration:I(i),createLayout:e=>{const t=x(e,n,i.state,i.pageContext,"composeWindow"),s="show"===i.state.dapi.emogenieEmojiState,o=T.V.getTotalWidth(T.V.gButtonMaxSize,s)+8,r=(0,A.Cq)((n||i.field).closest("table")),a=bi.x.createToolbarVisibleObservable(r),d=bi.x.createAttachmentsListObservable(r);return new F.A(n||i.field,{gbuttonMinPadding:6,proofitLayout:t,createGbuttonShiftBehavior:e=>{const t=(0,c.aj)([a,e.rect.behavior],((e,t)=>{if(e&&e.visible&&e.el){const i=e.el.getBoundingClientRect();return t.size.width-i.width-4<o?i.height+(i.bottom-t.client.top-t.size.height):0}return 0})),i=(0,c.aj)([bi.x.attachmentsMetricsObservable(d,e.rect.behavior,a),e.rect.behavior,e.scroll.behavior],((e,t,i)=>t.size.height-e.top+i.top>0&&t.size.width-e.width-4<o?t.size.height-e.top+i.top+4:0));return(0,c.aj)([t,i],((e,t)=>Math.max(e,t))).pipe((0,u.U)((e=>({top:-e,left:0}))),(0,g.d)())},injectIntegrationRoot:({editorElement:e,integrationRoot:t})=>{var i;null===(i=e.parentElement)||void 0===i||i.appendChild(t)},getScrollValue:e=>({top:e.scrollTop,left:i.field.scrollLeft})})},textMap:{createFieldTextMap:W.W.createTextMap},customizations:{richText:z.kn.isAvailable(i),applyFormatting:!0,getDocumentId:()=>{var e,t,n;const s=null===(e=i.field.closest('table[role="presentation"]'))||void 0===e?void 0:e.querySelector("form");return(null===(t=null==s?void 0:s.draft)||void 0===t?void 0:t.value)?(0,G.m3)(null===(n=null==s?void 0:s.draft)||void 0===n?void 0:n.value):void 0},getContainerType:()=>"email",getDocEvents:()=>{var e;const t=null===(e=i.field.closest('table[role="presentation"]'))||void 0===e?void 0:e.querySelector("form"),n=bi.x.getAuthor(),s=bi.x.getAuthorContextEventObservable(n),o=(0,Y.c)(null==t?void 0:t.subjectbox).pipe((0,h.b)(300),(0,u.U)((e=>V.t.createDocContextUpdatedEvent({title:e}))),(0,g.d)({bufferSize:1,refCount:!0})),r=t?bi.x.getRecipientsContextEventObservable(t,n).pipe((0,u.U)((e=>V.t.createDocContextUpdatedEvent({audience:{recipients:e,indirectRecipients:e.filter((e=>"indirect"===e.kind)),undisclosedRecipients:e.filter((e=>"undisclosed"===e.kind))}})))):null,d=bi.x.getSubmitObservable(i.field,r).pipe((0,u.U)(V.t.createPublishedEvent)),c=t?bi.x.getParentsContextEventObservable(t,n):null;return(0,a.T)(d,s,o,...r?[r]:[],...c?[c]:[])},...v},onCreate:bi.x.hideNativeSuggestions,onDispose:()=>{bi.x.showNativeSuggestions()},getFromEmailDomainAndSignature:e=>ne(e)}})),S=C(bi.x.isCompose,J.u.gmailCompose),y=C(bi.x.isFullscreenCompose,J.u.gmailComposeFullScreen),k=C(bi.x.isStandaloneCompose,J.u.gmailComposeStandalone);const E=q.T.contentEditable("Gmail.reply",(e=>({integrationName:J.u.gmailReply,extraCondition:e=>bi.x.isComposeReply(e.field)&&!w(e),expiration:I(e),createLayout:()=>function(e,t,i){const n=e.closest("table"),s=null==n?void 0:n.closest("table:not(:scope)"),o=null==s?void 0:s.querySelector('[command="Files"]'),r=null==o?void 0:o.closest("table"),a=(null==r?void 0:r.closest("div"))||null,l=(0,A.Cq)(e.offsetParent&&e.offsetParent.nodeType===Node.ELEMENT_NODE?"TD"===e.offsetParent.nodeName?n:e.offsetParent:null),h=(0,P.wr)(e,(e=>!!e.id&&"scroll"===(0,P.o)(e).overflowY))||e,p=(0,L.z)(h),m=(0,A.Cq)(e.closest("[role=listitem]")),f=x(e,l,t,i,"threads"),b=bi.x.createToolbarVisibleObservable(m),v=bi.x.createAttachmentsListObservable(m),w="show"===t.dapi.emogenieEmojiState,I=14,C=T.V.getTotalWidth(T.V.gButtonMaxSize,w)+4;return new F.A(e,{scroller:p,proofitLayout:f,customGbuttonPositioning:{injectionElement:a,createPositionStyleBehavior:e=>e.pipe((0,u.U)((e=>({position:"absolute",transform:"translate(0, -100%)",width:"auto",height:"auto",pointerEvents:"all",right:I-e.left+"px",top:`${-14+e.top}px`})))),injectionStyle:{top:"0",left:"auto",right:"0"},calculateMetrics:(e,t,i)=>{const n=M.p8.create({top:i.top-I,left:e.size.width+i.left-I});return{offset:n,page:M.Cv.fromOffset(n,M.Cv.fromClient(e.client,{top:t.scrollY,left:t.scrollX}),{top:0,left:0}),client:M.Ir.create(M.E9.plus(e.client,n)),effectivePadding:{top:0,right:0,bottom:0,left:0},size:T.V.gButtonMaxSize}},createShiftBehavior:(e,t)=>{const i=(0,c.aj)([b,e.behavior]).pipe((0,u.U)((([e,t])=>{if(e&&e.visible&&e.el){const i=e.el.getBoundingClientRect();return i.left+i.width+4>t.client.left+t.size.width-C-I?t.client.top-i.top:0}return 0}))),n=(0,c.aj)([bi.x.attachmentsMetricsObservable(v,t.rect.behavior,b),t.rect.behavior,e.behavior,(0,d.R)(h,"scroll").pipe((0,_.O)(null))]).pipe((0,u.U)((([i,n,s,o])=>{if(i.top){const n=t.rect.getCurrent(),s=e.getCurrent(),o=s.client.left+s.size.width-C-I;return i.top&&n.client.left+i.width>o&&n.client.top+i.top<s.client.top?s.client.top-(n.client.top+i.top):0}return 0})));return(0,c.aj)([i,n]).pipe((0,u.U)((([e,t])=>Math.max(e,t)))).pipe((0,u.U)((e=>({top:-e,left:0}))),(0,_.O)({top:0,left:0}),(0,g.d)())}}})}(e.field,e.state,e.pageContext),textMap:{createFieldTextMap:W.W.createTextMap},onCreate:bi.x.hideNativeSuggestions,onDispose:bi.x.showNativeSuggestions,customizations:{richText:z.kn.isAvailable(e),applyFormatting:!0,getDocumentId:e=>{var t,i,n;const s=null===(t=e.closest('table[role="presentation"]'))||void 0===t?void 0:t.querySelector("form");return(null===(i=null==s?void 0:s.draft)||void 0===i?void 0:i.value)?(0,G.m3)(null===(n=null==s?void 0:s.draft)||void 0===n?void 0:n.value):void 0},getContainerType:()=>"email",getDocEvents:()=>{var t;const i=bi.x.getAuthor(),n=bi.x.getAuthorContextEventObservable(i),s=null===(t=e.field.closest('table[role="presentation"]'))||void 0===t?void 0:t.querySelector("form"),o=s?bi.x.getRecipientsContextEventObservable(s,i).pipe((0,u.U)((e=>V.t.createDocContextUpdatedEvent({audience:{recipients:e,indirectRecipients:e.filter((e=>"indirect"===e.kind)),undisclosedRecipients:e.filter((e=>"undisclosed"===e.kind))}})))):null,r=bi.x.getSubmitObservable(e.field,o).pipe((0,u.U)(V.t.createPublishedEvent)),d=s?bi.x.getParentsContextEventObservable(s,i):null,c=(null==s?void 0:s.subject)?(0,l.of)(String((null==s?void 0:s.subject.value)||"")).pipe((0,u.U)((e=>V.t.createDocContextUpdatedEvent({title:e})))):null;return(0,a.T)(r,n,...c?[c]:[],...o?[o]:[],...d?[d]:[])},...v},getFromEmailDomainAndSignature:e=>ne(e)}))),U=(0,H.$W)({name:"gmail",domain:Q.ki,pathname:/^\/mail\/.*$/,andCanExecute:e=>!e.doc.querySelector("body>table"),eventPropagationHandler:e=>{(0,Z.E)().experimentClient.isGateEnabled(B.K.CentralizeStopEventPropagation)||e.addEventListener("keypress",(e=>{e.stopPropagation()}))}},[E,y,k,S,K.k.iframeHostRule]),R=(0,H.AY)({name:"gmail-general-purpose",domain:Q.ki,pathname:/^\/mail\/.*$/,andCanExecute:e=>!e.doc.querySelector("body>table")&&(0,b.c)(e.experimentClient)},[(e,t,i,o)=>new _i(t,e,(()=>[...(0,b.c)(e.experimentClient)?[n.knowledgeHub]:[]]),[n=>(0,s.zG)((0,b.c)(e.experimentClient),(e=>e?f.G({integration:new N(n,o,t,i,(0,X.Tb)())}):f.YP))])],"gmail-general-purpose-page-integration-rule"),te=(0,H.$W)({name:"gmail-chat",domain:Q.ki,pathname:/^\/chat\/.*$/},[K.k.iframeHostRule,...K.k.newLayoutRules]),ie=(0,H.$W)({name:"gmail-feedback",andCanExecute:e=>{var t,i,n;return(0,O.n_)()&&"google-feedback-iframe"===(null===(n=null===(i=null===(t=e.doc)||void 0===t?void 0:t.defaultView)||void 0===i?void 0:i.frameElement)||void 0===n?void 0:n.getAttribute("id"))}},[q.T.textarea("Gmail.feedback",(e=>({createLayout:()=>new F.A(e.field,{}),extraCondition:()=>!1})))]);function ne(e){return{fromEmailDomain:bi.x.getAuthorDomain(),emailSignature:ee.X.getSignature(e)}}e.pages=[U,te,ie],e.generalPurpose=[R]}(fi||(fi={}))},65233:(e,t,i)=>{i.d(t,{c:()=>c});var n=i(64965),s=i(8748),o=i(65647),r=i(55446),a=i(60165),d=i(14765);function c(e){const t=e||null;return t?(0,n.R)(t,"input").pipe((0,o.U)((e=>e.target)),(0,r.h)((e=>e===t)),(0,o.U)((e=>e.value)),(0,a.x)(),(0,d.O)(t.value)):s.E}}}]);